云主机资源使用评估报告
==

结论
--


容量 = 总内存 / 单容器开销

之前我们评估的数据 Mysql容器开销 600M +  Lims 开销 200 M
32780M /(200M + 600 M)  = 40 (个) 客户

32780M / 200M = 163 (个) 客户.

对比下来, 采用云数据库后, 系统最大可支持[空载]容器 163个.

- 其他因素

 考虑到系统本身自己还要消耗一部分内存, SunwayCloud对内存的开销大约是4G 
 
 另外目前评估的是[空载]容器, 将来有用户的情况下, 实际开销比这个大.

 压力测试今天没能完成. 
 
 (原因: 今天 董宗思在测试的时候遇到困难, 由于云端只开放了80端口, 而nginx又只能对http请求做代理,无法对普通的socket请求做代理, 所以她用的LoadRunner没法和云主机通信, 无法完成压力测试.)

数据支持
--
 
目前服务器总内存情况:

```
MemTotal:       32780412 kB
MemFree:        15440304 kB
MemAvailable:   19749120 kB
```

CPU 内核数量

```
cpu cores       : 16

```

容器运行时开销(空载,无用户使用Lims)

注意下面倒数第二行,有一个运行时开销是3.08G的, 是mysql容器, 目前在被SunwayCloud平台使用.

而Lims产品容器的运行时开销大约在 200M 左右.  因此可以乐观的估计,  采用云数据库后, 系统负担会大大降低.  

32780M / 200M = 163 (个) 客户.

之前我们评估的数据 Mysql容器开销 600M +  Lims 开销 200 M
32780M /(200M + 600 M)  = 40 (个) 客户

对比下来, 采用云数据库后, 系统最大可支持空载容器 163个.

压力测试今天没能完成.


```
CONTAINER           CPU %               MEM USAGE / LIMIT     MEM %               NET I/O             BLOCK I/O           PIDS
5b2cc4150c45        0.03%               193.5MiB / 31.26GiB   0.60%               429B / 0B           4.1kB / 397MB       27
e0ec5f0ca050        0.05%               197.4MiB / 31.26GiB   0.62%               503B / 0B           4.1kB / 401MB       27
871e1fe509ec        0.14%               194.3MiB / 31.26GiB   0.61%               503B / 0B           4.1kB / 396MB       27
a5842a4082c4        0.05%               194.9MiB / 31.26GiB   0.61%               2.69kB / 0B         0B / 399MB          27
de1ed4df2d87        0.06%               195.5MiB / 31.26GiB   0.61%               2.69kB / 0B         4.1kB / 404MB       27
8387159a8bcb        0.07%               190.1MiB / 31.26GiB   0.59%               2.69kB / 0B         2.35MB / 402MB      27
6bb461343ca7        0.05%               220MiB / 31.26GiB     0.69%               11.8MB / 40.2MB     24.5MB / 555MB      46
7dd15e3e3279        0.26%               3.081GiB / 31.26GiB   9.86%               30.2MB / 99.6MB     20.1MB / 206MB      95
a2e357f814bf        0.06%               211.5MiB / 31.26GiB   0.66%               11.1MB / 25.1MB     32.9MB / 16.9MB     31
```

Docker的内存和cpu分配
--
- 内存

Docker在启动容器时, 可以设定最大使用内存, 系统运行不会超出这个限制.

- CPU

CPU分配有两个策略,  

一个是 权重策略,  每个容器可以设定权重, 在CPU资源很充分的时候, 每个容器可以获取足够的资源,  但是CPU满负荷时,  权重开始生效, 按权重比例进行分配.

另一个是时间片分配策略,  这种策略比较固定, 容器只会使用指定大小的时间片. 即使CPU有很多富余, 也不给会给容器使用.

- 个人建议第一个策略比较好.  用户体验好.  


关于压力测试和带宽
--

今天 董宗思在测试的时候遇到困难,  由于云端只开放了80端口, 而nginx又只能对http请求做代理,无法对普通的socket请求做代理,  所以她用的LoadRunner没法和云主机通信, 无法完成压力测试.






